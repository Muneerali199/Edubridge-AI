<div class="ai-tutor-container">
    <!-- Header -->
    <div class="chat-header">
        <div class="tutor-avatar">
            <mat-icon class="avatar-icon">school</mat-icon>
            <div class="status-indicator" [class.active]="isAIAvailable()"></div>
        </div>
        <div class="tutor-info">
            <h2 class="tutor-name">EduBridge AI Tutor</h2>
            <p class="tutor-status" *ngIf="isAIAvailable()">
                <mat-icon class="status-icon">circle</mat-icon>
                Online & Ready to Help
            </p>
            <p class="tutor-status offline" *ngIf="!isAIAvailable()">
                <mat-icon class="status-icon">warning</mat-icon>
                Please add Gemini API key
            </p>
        </div>
        <div class="header-actions">
            <button mat-icon-button [matTooltip]="isSpeaking() ? 'Stop Speaking' : 'Voice Controls'" (click)="stopVoice()" *ngIf="isSpeaking()">
        <mat-icon>stop_circle</mat-icon>
      </button>
            <button mat-icon-button matTooltip="Clear Chat" (click)="clearChat()">
        <mat-icon>delete_outline</mat-icon>
      </button>
        </div>
    </div>

    <!-- Messages Container -->
    <div class="messages-container" #messagesContainer (scroll)="onScroll()">
        <div class="messages-wrapper">
            @for (message of messages(); track message.id) {
            <div class="message" [class.user-message]="message.role === 'user'" [class.ai-message]="message.role === 'assistant'">

                <!-- AI Avatar -->
                @if (message.role === 'assistant') {
                <div class="message-avatar ai-avatar">
                    <mat-icon>smart_toy</mat-icon>
                </div>
                }

                <!-- Message Content -->
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="message-text" [innerHTML]="message.content | markdown"></div>
                        <div class="message-meta">
                            <span class="message-time">{{ formatMessageTime(message.timestamp) }}</span> @if (message.role === 'assistant') {
                            <button mat-icon-button class="speak-button" (click)="speakMessage(message)" [matTooltip]="isSpeaking() ? 'Stop' : 'Listen'">
                    <mat-icon>{{ isSpeaking() ? 'stop' : 'volume_up' }}</mat-icon>
                  </button> }
                        </div>
                    </div>
                </div>

                <!-- User Avatar -->
                @if (message.role === 'user') {
                <div class="message-avatar user-avatar">
                    <mat-icon>person</mat-icon>
                </div>
                }
            </div>
            }

            <!-- Typing Indicator -->
            @if (isTyping()) {
            <div class="message ai-message typing-indicator">
                <div class="message-avatar ai-avatar">
                    <mat-icon>smart_toy</mat-icon>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </div>
            }

            <!-- Empty State -->
            @if (messages().length === 0 && !isTyping()) {
            <div class="empty-state">
                <mat-icon class="empty-icon">psychology</mat-icon>
                <h3>Start Learning with AI</h3>
                <p>Ask me anything! I'm here to help you understand concepts, solve problems, and master your subjects.</p>
            </div>
            }
        </div>
    </div>

    <!-- Quick Actions -->
    @if (messages().length > 0) {
    <div class="quick-actions">
        @for (action of quickActions; track action.action) {
        <button mat-stroked-button class="quick-action-btn" (click)="handleQuickAction(action.action)">
          <mat-icon>{{ action.icon }}</mat-icon>
          <span>{{ action.text }}</span>
        </button> }
    </div>
    }

    <!-- Input Area -->
    <div class="input-area">
        @if (!isAIAvailable()) {
        <div class="api-key-notice">
            <mat-icon>info</mat-icon>
            <span>Add your Gemini API key in <code>environment.ts</code> to enable AI tutor</span>
            <a href="https://makersuite.google.com/app/apikey" target="_blank" mat-button>
          Get API Key
        </a>
        </div>
        }

        <div class="input-wrapper" [class.disabled]="!isAIAvailable()">
            <button mat-icon-button class="voice-button" [class.listening]="isListening()" (click)="toggleVoiceInput()" [disabled]="!isAIAvailable()" [matTooltip]="isListening() ? 'Stop Listening' : 'Voice Input'">
        <mat-icon>{{ isListening() ? 'mic_off' : 'mic' }}</mat-icon>
      </button>

            <mat-form-field class="message-field" appearance="outline">
                <input matInput #messageInput [(ngModel)]="userInput" (keypress)="handleKeyPress($event)" placeholder="Type your question or use voice..." [disabled]="!isAIAvailable()" autocomplete="off">
            </mat-form-field>

            <button mat-fab class="send-button" (click)="sendMessage()" [disabled]="!userInput.trim() || !isAIAvailable() || isTyping()" color="primary">
        <mat-icon>send</mat-icon>
      </button>
        </div>

        @if (isListening()) {
        <div class="listening-indicator">
            <div class="pulse-ring"></div>
            <mat-icon class="listening-icon">mic</mat-icon>
            <span>Listening...</span>
        </div>
        }
    </div>
</div>